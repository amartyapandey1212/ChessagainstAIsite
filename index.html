<!DOCTYPE html>
<html>
<head>
    <title>Chess vs Stockfish</title>
    <style>
        .chessboard {
            width: 560px;
            height: 560px;
            border: 2px solid #333;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
        }

        .square {
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            cursor: pointer;
        }

        .white {
            background-color: #f0d9b5;
        }

        .black {
            background-color: #b58863;
        }

        .selected {
            background-color: rgba(0, 255, 0, 0.5);
        }

        .possible-move {
            background-color: rgba(255, 255, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="chessboard" id="board"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js"></script>
    <script src="stockfish.js"></script>

    <script>
        const boardElement = document.getElementById('board');
        const game = new Chess();
        let selectedSquare = null;
        let possibleMoves = [];

        // Initialize Stockfish
        const stockfish = new Worker('stockfish.js');
        stockfish.onmessage = (event) => {
            if (event.data.includes('bestmove')) {
                const bestMove = event.data.split('bestmove ')[1].split(' ')[0];
                makeMove(bestMove);
            }
        };

        // Initialize board
        function createBoard() {
            boardElement.innerHTML = '';
            for (let i = 0; i < 64; i++) {
                const square = document.createElement('div');
                const row = 8 - Math.floor(i / 8);
                const col = 'abcdefgh'[i % 8];
                square.className = `square ${(i + Math.floor(i / 8)) % 2 === 0 ? 'white' : 'black'}`;
                square.dataset.position = col + row;
                square.addEventListener('click', handleSquareClick);
                boardElement.appendChild(square);
            }
            updateBoard();
        }

        // Update piece positions
        function updateBoard() {
            document.querySelectorAll('.square').forEach(square => {
                const position = square.dataset.position;
                const piece = game.get(position);
                square.textContent = piece ? getUnicodePiece(piece) : '';
            });
        }

        // Convert piece to Unicode
        function getUnicodePiece(piece) {
            const unicodePieces = {
                'p': '♟', 'n': '♞', 'b': '♝', 'r': '♜', 'q': '♖', 'k': '♔',
                'P': '♙', 'N': '♘', 'B': '♗', 'R': '♖', 'Q': '♕', 'K': '♔'
            };
            return unicodePieces[piece.color === 'w' ? piece.type.toUpperCase() : piece.type];
        }

        // Handle square clicks
        function handleSquareClick(e) {
            const position = e.target.dataset.position;
            
            if (selectedSquare === position) {
                clearSelection();
                return;
            }

            if (selectedSquare) {
                const move = game.move({
                    from: selectedSquare,
                    to: position,
                    promotion: 'q'
                });

                if (move) {
                    clearSelection();
                    updateBoard();
                    stockfish.postMessage(`position fen ${game.fen()}`);
                    stockfish.postMessage('go depth 10');
                    return;
                }
            }

            const moves = game.moves({ square: position, verbose: true });
            if (moves.length > 0 && game.turn() === 'w') {
                selectedSquare = position;
                possibleMoves = moves.map(move => move.to);
                highlightSquares();
            }
        }

        // Highlight selected and possible moves
        function highlightSquares() {
            document.querySelectorAll('.square').forEach(square => {
                square.classList.remove('selected', 'possible-move');
                if (square.dataset.position === selectedSquare) {
                    square.classList.add('selected');
                } else if (possibleMoves.includes(square.dataset.position)) {
                    square.classList.add('possible-move');
                }
            });
        }

        // Clear selection
        function clearSelection() {
            selectedSquare = null;
            possibleMoves = [];
            document.querySelectorAll('.square').forEach(square => {
                square.classList.remove('selected', 'possible-move');
            });
        }

        // Make computer move
        function makeMove(move) {
            game.move(move);
            updateBoard();
        }

        // Initialize stockfish communication
        stockfish.postMessage('uci');
        stockfish.postMessage('isready');
        createBoard();
    </script>
</body>
</html>
